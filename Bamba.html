<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LUMBI INTERNATIONAL ACADEMY - Math Quiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            min-height: 100vh;
        }
        /* Custom message box styling */
        #message-box {
            z-index: 1000;
        }
        /* Style for the option buttons */
        .quiz-option {
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            word-break: break-word; /* Ensure long answers wrap nicely */
            text-align: left;
        }
        .quiz-option:not(.disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        /* Animation for correct answer pulse */
        @keyframes correctPulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            50% { transform: scale(1.01); box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }
        .pulse-correct {
            animation: correctPulse 0.4s ease-out;
        }
        /* Custom loading spinner */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: none;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 sm:p-8 flex items-center justify-center">

    <div id="app" class="bg-white p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-2xl">
        
        <h1 class="text-3xl font-bold text-gray-800 mb-2 text-center">LUMBI INTERNATIONAL ACADEMY</h1>
        <h2 class="text-xl font-semibold text-indigo-600 mb-4 text-center">Mathematics Objective Quiz</h2>
        <p class="text-sm text-gray-500 mb-6 text-center">Test your basic math skills across 30 questions.</p>

        <div id="loading" class="flex justify-center items-center h-40">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-500"></div>
            <p class="ml-3 text-indigo-600">Loading quiz and authenticating...</p>
        </div>

        <div id="quiz-container" class="hidden">
            <div id="score-display" class="mb-4 text-sm font-semibold text-right text-indigo-600">
                Score: 0 / 30
            </div>

            <div class="mb-6 bg-indigo-50 p-4 rounded-lg shadow-inner">
                <p id="question-number" class="text-xs font-medium text-indigo-500 mb-1">Question 1 of 30</p>
                <p id="question-text" class="text-xl font-semibold text-gray-700">Loading question...</p>
            </div>
            
            <div id="options-container" class="space-y-3">
                </div>

            <div class="mt-8 flex justify-between items-center">
                <button id="next-button" 
                        class="bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-indigo-700 transition duration-150 disabled:bg-indigo-300 flex items-center" 
                        disabled>
                    Next Question 
                    <div id="next-loading" class="spinner ml-2"></div>
                </button>
                <p id="feedback-message" class="font-bold text-lg"></p>
            </div>
        </div>

        <div id="results-screen" class="hidden text-center py-10">
            <h2 class="text-3xl font-extrabold text-indigo-600 mb-4">Quiz Finished! ðŸŽ‰</h2>
            <p class="text-6xl font-black text-gray-800" id="final-score">0 / 30</p>
            <p class="text-lg text-gray-600 mt-2" id="score-message"></p>
            <button id="restart-button" 
                    class="mt-6 bg-green-500 text-white font-semibold py-2 px-6 rounded-lg hover:bg-green-600 transition duration-150">
                Restart Quiz
            </button>
        </div>
    </div>

    <div id="message-box" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
            <p id="modal-text" class="text-gray-700 mb-4 text-center"></p>
            <button id="modal-ok-button" class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition">OK</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase access
        let app, db, auth, userId;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // ** FIX 1: Determine if Firebase setup should be skipped **
        const shouldRunQuizWithoutFirebase = !firebaseConfig;

        // Set log level for debugging
        setLogLevel('Debug');

        // Function to initialize and authenticate Firebase
        async function initializeFirebaseAndAuth() {
            // ** FIX 2: Gracefully skip Firebase and start the quiz if config is missing **
            if (shouldRunQuizWithoutFirebase) {
                console.warn("Firebase configuration missing. Starting quiz locally without score saving.");
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('quiz-container').classList.remove('hidden');
                window.startQuiz(); 
                return;
            }

            try {
                // The rest of the original Firebase initialization logic
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        window.startQuiz();
                    } else {
                        console.error("Authentication failed: No user found.");
                        document.getElementById('loading').innerHTML = '<p class="text-red-600">Error: Could not authenticate user.</p>';
                    }
                });
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                document.getElementById('loading').innerHTML = `<p class="text-red-600">Error initializing Firebase: ${error.message}</p>`;
            }
        }

        // Expose function to save score to Firestore
        window.saveScore = async (score, total) => {
            // ** FIX 3: Prevent saving score if Firebase was skipped **
            if (shouldRunQuizWithoutFirebase || !db || !userId) {
                console.warn("Skipping score save: Running locally or database not ready.");
                return;
            }

            const scoreData = {
                score: score,
                totalQuestions: total,
                percentage: (score / total) * 100,
                timestamp: new Date().toISOString(),
                userId: userId
            };

            try {
                const collectionPath = `/artifacts/${appId}/users/${userId}/quiz_scores`;
                await addDoc(collection(db, collectionPath), scoreData);
                console.log("Score saved successfully to Firestore.");
            } catch (error) {
                console.error("Error saving score to Firestore:", error);
            }
        };

        // Initialize Firebase on window load
        initializeFirebaseAndAuth();
    </script>

    <script>
        // Data is correct
        const quizData = [
            { question: "What is the product of 45 and 12?", options: ["500", "540", "580", "520"], correctAnswer: "540" },
            { question: "The temperature was -5Â°C and then rose by 8Â°C. What is the new temperature?", options: ["13Â°C", "3Â°C", "-13Â°C", "-3Â°C"], correctAnswer: "3Â°C" },
            { question: "A farmer has 3,450 mangoes and sells 1,275. How many mangoes are left?", options: ["2,275", "2,175", "4,725", "2,075"], correctAnswer: "2,175" },
            { question: "Write the number 12,508 in words.", options: ["Twelve thousand five hundred and eight", "Twelve thousand and fifty-eight", "One thousand two hundred fifty-eight", "Twelve thousand five hundred eighty"], correctAnswer: "Twelve thousand five hundred and eight" },
            { question: "If a = 5 and b = 3, what is the value of 2aÂ²?", options: ["20", "50", "30", "100"], correctAnswer: "50" },
            { question: "Find the sum of 25,430 and 18,765.", options: ["44,195", "43,195", "44,095", "43,095"], correctAnswer: "44,195" },
            { question: "A box holds 24 packets of biscuits. How many packets are in 15 boxes?", options: ["360", "300", "390", "350"], correctAnswer: "360" },
            { question: "What is seven thousand and nineteen in figures?", options: ["7,019", "7,190", "719", "7,009"], correctAnswer: "7,019" },
            { question: "Calculate: 846 Ã· 6.", options: ["141", "140", "141 R2", "142"], correctAnswer: "141" },
            { question: "Simplify: (-10) - (-4)", options: ["-14", "-6", "14", "6"], correctAnswer: "-6" },
            { question: "A school has 1,248 students. If they are to be divided equally into 8 classes, how many students will be in each class?", options: ["156", "166", "146", "155"], correctAnswer: "156" },
            { question: "What is 6Â³?", options: ["18", "216", "36", "196"], correctAnswer: "216" },
            { question: "Subtract 8,099 from 10,001.", options: ["1,902", "2,002", "1,903", "1,098"], correctAnswer: "1,902" },
            { question: "Multiply 63 by 17.", options: ["1,071", "1,081", "1,061", "1,171"], correctAnswer: "1,071" },
            { question: "The number 10,010 is best written in words as", options: ["ten thousand and one", "ten thousand and ten", "one thousand and ten", "ten thousand one hundred"], correctAnswer: "ten thousand and ten" },
            { question: "Find the value of 144 Ã· 12.", options: ["11", "13", "10", "12"], correctAnswer: "12" },
            { question: "A submarine is at 150m below sea level, written as -150m. It ascends 60m. What is its new position?", options: ["-210m", "-90m", "+90m", "+210m"], correctAnswer: "-90m" },
            { question: "What is 15 Ã— 15?", options: ["200", "225", "250", "275"], correctAnswer: "225" },
            { question: "Add forty-two thousand, one hundred and six to five thousand and seventy-three.", options: ["47,179", "47,279", "46,179", "47,189"], correctAnswer: "47,179" },
            { question: "If 7 Ã— 8 = 56, what is 70 Ã— 80?", options: ["5,600", "560", "56,000", "560,000"], correctAnswer: "5,600" },
            { question: "The result of 5 - 9 + 2 is", options: ["-2", "2", "16", "-6"], correctAnswer: "-2" },
            { question: "Divide 672 by 4.", options: ["168", "167", "178", "188"], correctAnswer: "168" },
            { question: "Express 10â´ as a whole number.", options: ["40", "10,000", "1,000", "104"], correctAnswer: "10,000" },
            { question: "A book has 156 pages. How many pages are in 32 such books?", options: ["4,892", "4,992", "4,882", "4,982"], correctAnswer: "4,992" },
            { question: "Write 90,407 in words.", options: ["Ninety thousand four hundred and seven", "Nine thousand four hundred and seven", "Ninety thousand four hundred and seventy", "Ninety thousand and forty-seven"], correctAnswer: "Ninety thousand four hundred and seven" },
            { question: "Find the difference between 50,000 and 32,678.", options: ["17,322", "18,322", "17,422", "18,422"], correctAnswer: "17,322" },
            { question: "Evaluate: (-3) + (+7)", options: ["-10", "+4", "-4", "+10"], correctAnswer: "+4" },
            { question: "What is the remainder when 587 is divided by 9?", options: ["2", "3", "4", "5"], correctAnswer: "2" },
            { question: "The square of 19 is", options: ["361", "351", "371", "381"], correctAnswer: "361" },
            { question: "A man walked 5km east, then 3km west. Using directed numbers, his final position can be represented as:", options: ["+8km", "+2km", "-2km", "-8km"], correctAnswer: "+2km" },
        ];
        
        const TOTAL_QUESTIONS = quizData.length;
        let currentQuestionIndex = 0;
        let score = 0;
        let isAnswered = false;

        // DOM elements
        const quizContainer = document.getElementById('quiz-container');
        const loadingScreen = document.getElementById('loading');
        const questionNumberEl = document.getElementById('question-number');
        const questionTextEl = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const scoreDisplay = document.getElementById('score-display');
        const nextButton = document.getElementById('next-button');
        const feedbackMessage = document.getElementById('feedback-message');
        const resultsScreen = document.getElementById('results-screen');
        const finalScoreEl = document.getElementById('final-score');
        const scoreMessageEl = document.getElementById('score-message');
        const restartButton = document.getElementById('restart-button');
        const modalBox = document.getElementById('message-box');
        const modalText = document.getElementById('modal-text');
        const modalOkButton = document.getElementById('modal-ok-button');

        // Utility function for custom message box (no alert/confirm)
        function showMessage(text) {
            modalText.textContent = text;
            modalBox.classList.remove('hidden');
            modalBox.classList.add('flex');
            modalOkButton.focus();
        }

        modalOkButton.onclick = () => {
            modalBox.classList.add('hidden');
            modalBox.classList.remove('flex');
        };
        
        // ** FIX 4: Normalization function for robust string comparison **
        function normalizeAnswer(str) {
            if (typeof str !== 'string') return String(str).trim();
            let normalized = str.trim();
            // Remove a leading '+' sign for consistent comparison (e.g., '+4' becomes '4')
            if (normalized.startsWith('+')) {
                // If it's a number/measurement with a + (e.g., +4, +2km), strip the sign.
                // This ensures '4' and '+4' are treated as the same correct answer.
                normalized = normalized.substring(1);
            }
            return normalized;
        }


        // Render the current question
        function renderQuestion() {
            if (currentQuestionIndex >= TOTAL_QUESTIONS) {
                showResults();
                return;
            }

            const currentQ = quizData[currentQuestionIndex];
            
            // Reset state
            isAnswered = false;
            nextButton.disabled = true;
            nextButton.classList.add('opacity-50');
            feedbackMessage.textContent = '';
            
            // Update UI
            questionNumberEl.textContent = `Question ${currentQuestionIndex + 1} of ${TOTAL_QUESTIONS}`;
            questionTextEl.innerHTML = currentQ.question;
            scoreDisplay.textContent = `Score: ${score} / ${TOTAL_QUESTIONS}`;
            optionsContainer.innerHTML = '';

            // Render options
            currentQ.options.forEach((option, index) => {
                const button = document.createElement('button');
                // Use innerHTML for mathematical symbols (&divide;, &times;)
                const optionText = option.replace(/Ã·/g, ' &divide; ').replace(/Ã—/g, ' &times; ');
                
                button.innerHTML = `(${String.fromCharCode(97 + index)}) ${optionText}`;
                
                // Store the exact option value in a data attribute
                button.setAttribute('data-answer', option); 
                
                button.className = 'quiz-option w-full p-4 bg-white border border-gray-200 rounded-lg shadow-md font-medium text-gray-700 transition duration-150';
                button.onclick = () => handleAnswer(option, button, currentQ.correctAnswer);
                optionsContainer.appendChild(button);
            });
        }

        // Handle answer selection with enhanced animation
        function handleAnswer(selectedOption, clickedButton, correctAnswer) {
            if (isAnswered) return; // Prevent multiple clicks

            // ** FIX 5: Use normalized strings for robust comparison **
            const normalizedSelected = normalizeAnswer(selectedOption);
            const normalizedCorrect = normalizeAnswer(correctAnswer);


            isAnswered = true;
            nextButton.disabled = false;
            nextButton.classList.remove('opacity-50');

            const allOptions = optionsContainer.querySelectorAll('.quiz-option');
            allOptions.forEach(btn => {
                btn.classList.add('disabled');
                btn.onclick = null; // Disable further clicks
                btn.classList.remove('hover:bg-indigo-50');

                // Get and normalize the option value from the data attribute
                const optionValue = btn.getAttribute('data-answer');
                const normalizedOptionValue = normalizeAnswer(optionValue);

                // Check if this option is the correct one to highlight it
                if (normalizedOptionValue === normalizedCorrect) {
                    // Highlight the correct answer strongly
                    btn.classList.remove('bg-white', 'text-gray-700', 'border-gray-200');
                    btn.classList.add('bg-green-200', 'border-green-500', 'text-green-900', 'font-bold', 'pulse-correct');
                } else {
                     // Dim all incorrect answers
                    btn.classList.add('opacity-70');
                }
            });

            // Check if selected answer is correct
            if (normalizedSelected === normalizedCorrect) {
                score++;
                feedbackMessage.textContent = 'Correct! âœ…';
                feedbackMessage.classList.remove('text-red-500');
                feedbackMessage.classList.add('text-green-600');
            } else {
                feedbackMessage.textContent = 'Wrong. âŒ';
                feedbackMessage.classList.remove('text-green-600');
                feedbackMessage.classList.add('text-red-500');
                // Highlight the selected (wrong) button clearly in red
                clickedButton.classList.remove('bg-white', 'opacity-70');
                clickedButton.classList.add('bg-red-200', 'border-red-500', 'text-red-900');
            }
            
            scoreDisplay.textContent = `Score: ${score} / ${TOTAL_QUESTIONS}`;
        }

        // Move to the next question
        nextButton.onclick = () => {
            currentQuestionIndex++;
            if (currentQuestionIndex < TOTAL_QUESTIONS) {
                renderQuestion();
            } else {
                showResults();
            }
        };

        // Show final results screen
        function showResults() {
            quizContainer.classList.add('hidden');
            resultsScreen.classList.remove('hidden');
            
            finalScoreEl.textContent = `${score} / ${TOTAL_QUESTIONS}`;
            
            let message = '';
            const percentage = (score / TOTAL_QUESTIONS) * 100;

            if (percentage >= 80) {
                message = "Excellent work! You have a strong grasp of the material.";
            } else if (percentage >= 50) {
                message = "Good job! You're halfway there, keep practicing.";
            } else {
                message = "Keep studying and try again! Practice makes perfect.";
            }
            scoreMessageEl.textContent = message;

            // Save the score to Firestore (will be skipped if running locally)
            if (window.saveScore) {
                window.saveScore(score, TOTAL_QUESTIONS);
            } else {
                console.warn("Firestore saveScore function not available.");
            }
        }

        // Restart the quiz
        restartButton.onclick = () => {
            currentQuestionIndex = 0;
            score = 0;
            resultsScreen.classList.add('hidden');
            quizContainer.classList.remove('hidden');
            renderQuestion();
        };

        // Initialize the quiz after Firebase authentication completes (or is skipped)
        window.startQuiz = () => {
            loadingScreen.classList.add('hidden');
            quizContainer.classList.remove('hidden');
            renderQuestion();
        };
        
    </script>
</body>
</html>